<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Recovery Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background: #2563eb; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #dc2626; }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 6px;
      background: #f0f9ff;
      border-left: 4px solid #3b82f6;
    }
    .error {
      background: #fef2f2;
      border-left-color: #ef4444;
      color: #991b1b;
    }
    .success {
      background: #f0fdf4;
      border-left-color: #22c55e;
      color: #166534;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ Session Recovery Test</h1>
    <p>Use this page to test the session corruption fix.</p>

    <div id="status" class="status">
      Ready to test...
    </div>

    <div style="margin: 20px 0;">
      <h3>Test Actions:</h3>
      <button onclick="checkSession()">Check Session</button>
      <button onclick="checkCookies()">Check Cookies</button>
      <button onclick="checkLocalStorage()">Check LocalStorage</button>
      <button onclick="simulateCorruption()" class="danger">Simulate Corruption</button>
      <button onclick="clearAll()" class="danger">Clear All Session Data</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status';
      if (type === 'error') status.classList.add('error');
      if (type === 'success') status.classList.add('success');
    }

    function displayOutput(title, data) {
      const output = document.getElementById('output');
      output.innerHTML = `
        <h3>${title}</h3>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    function checkSession() {
      updateStatus('Checking session...');
      
      // Check if we're in the app context
      if (typeof window !== 'undefined') {
        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
          const [key, value] = cookie.trim().split('=');
          if (key.startsWith('sb-')) {
            acc[key] = value ? value.substring(0, 20) + '...' : 'empty';
          }
          return acc;
        }, {});

        displayOutput('Session Cookies', cookies);
        
        if (Object.keys(cookies).length === 0) {
          updateStatus('No session cookies found', 'error');
        } else {
          updateStatus(`Found ${Object.keys(cookies).length} session cookie(s)`, 'success');
        }
      }
    }

    function checkCookies() {
      updateStatus('Checking all cookies...');
      
      const allCookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.trim().split('=');
        acc[key] = value ? value.substring(0, 30) + '...' : 'empty';
        return acc;
      }, {});

      displayOutput('All Cookies', allCookies);
      updateStatus(`Found ${Object.keys(allCookies).length} total cookie(s)`, 'info');
    }

    function checkLocalStorage() {
      updateStatus('Checking localStorage...');
      
      const storage = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('sb-')) {
          const value = localStorage.getItem(key);
          storage[key] = value ? value.substring(0, 30) + '...' : 'empty';
        }
      }

      displayOutput('LocalStorage (Supabase keys)', storage);
      
      if (Object.keys(storage).length === 0) {
        updateStatus('No Supabase data in localStorage (Good! Using cookies only)', 'success');
      } else {
        updateStatus(`Found ${Object.keys(storage).length} localStorage item(s) - This might cause issues!`, 'error');
      }
    }

    function simulateCorruption() {
      if (!confirm('This will corrupt your session cookies. Continue?')) return;
      
      updateStatus('Simulating corruption...');
      
      // Set invalid cookie values
      document.cookie = 'sb-auth-token=corrupted_data; path=/';
      document.cookie = 'sb-access-token=invalid_token; path=/';
      
      updateStatus('Session corrupted! Try using the app now.', 'error');
      displayOutput('Corruption Applied', {
        message: 'Cookies have been set to invalid values',
        next: 'Try navigating in the app - it should auto-recover'
      });
    }

    function clearAll() {
      if (!confirm('This will clear all session data. Continue?')) return;
      
      updateStatus('Clearing all session data...');
      
      // Clear cookies
      const cookiesToClear = [
        'sb-access-token',
        'sb-refresh-token',
        'sb-auth-token',
        'sb-auth-token.0',
        'sb-auth-token.1'
      ];
      
      cookiesToClear.forEach(name => {
        document.cookie = `${name}=; max-age=0; path=/`;
      });
      
      // Clear localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('sb-')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      updateStatus('All session data cleared!', 'success');
      displayOutput('Cleanup Complete', {
        cookiesCleared: cookiesToClear.length,
        localStorageCleared: keysToRemove.length,
        message: 'You can now log in fresh'
      });
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      checkSession();
    });
  </script>
</body>
</html>
